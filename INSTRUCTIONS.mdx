# Composition Patterns

### 💡 Comment composer notre application de RCC et RSC

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Avec `Next` et les `React Server Components`, il faut toujours se poser la question. Dois-je faire une `RCC` (Client) ou un `RSC` (Serveur) et surtout comment organiser son application pour avoir des `RCC` et `RSC` qui s’imbriquent correctement.

**Faire 100% de RCC ?**

- On perd l’avantage du `SSR`, de la réduction du `bundle client` etc …

**Faire 100% de RSC ?**

- Impossible, car l’application n’aurait aucune interactivité.

![rcc-rsc-usage.png](/course/rcc-rsc-usage.png)

```tsx
![rcc-rsc-usage.png](/course/rcc-rsc-usage.png)
```

📑 Le lien vers la doc https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#when-to-use-server-and-client-components

Voilà à quoi pourrait ressembler un arbre de composants pour notre segment de route :

- Des `RSC` qui contiennent des `RCC`.
- Des `RCC` qui contiennent des `RSC`.

![rcc-rsc-tree](/course/rcc-rsc-tree.png)

```tsx
![rcc-rsc-tree.png](/course/rcc-rsc-tree.png)
```

Mais il y a certaines conditions à respecter.

- Les `RSC` peuvent contenir des `RCC` sans contraintes (par `import` ou `props`).
- Les `RCC` peuvent contenir des `RSC` (via `props` : `children` ou autres `props`).

Exemple :

- Il est interdit d’importer des `RCC` dans des `RCC`

```tsx
//app/client-component.tsx
'use client'

// You cannot import a Server Component into a Client Component.
import ServerComponent from './Server-Component'

export default function ClientComponent({
  children,
}: {
  children: React.ReactNode
}) {
  const [count, setCount] = useState(0)

  return (
    <>
      <button onClick={() => setCount(count + 1)}>{count}</button>
      <ServerComponent />
    </>
  )
}
```

- Solution de contournement (`props children`)

```tsx
//app/client-component.tsx
'use client'

import {useState} from 'react'

export default function ClientComponent({
  children,
}: {
  children: React.ReactNode
}) {
  const [count, setCount] = useState(0)

  return (
    <>
      <button onClick={() => setCount(count + 1)}>{count}</button>
      {children}
    </>
  )
}
```

```tsx
import ClientComponent from './client-component'
import ServerComponent from './server-component'

// Pages in Next.js are Server Components by default
export default function Page() {
  return (
    <ClientComponent>
      <ServerComponent />
    </ClientComponent>
  )
}
```

![rcc-rsc-tree-prop.png](/course/rcc-rsc-tree-prop.png)

```tsx
![rcc-rsc-tree-prop.png](/course/rcc-rsc-tree-prop.png)
```

📑 Le lien vers la doc [https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components](https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)

Pour les exercices, nous utiliserons un composant qui détecte le type du composant (en se basant sur la présence de `window`) et affiche une couleur

```tsx
const actualType = detectActualType()
//server ou client
export function detectActualType() {
  return typeof window === 'undefined'
    ? ComponentTypeEnum.SERVER
    : ComponentTypeEnum.CLIENT
}
```

- Rouge —> Client
- Bleu —> Serveur

![component-tree.png](/course/component-tree.png)

```tsx
![component-tree.png](/course/component-tree.png)
```

## Exercice

Dans cet exercice, nous allons essayer plusieurs combinaisons possibles

- Client → Server (`children`)
- Server → Client (`children`)
- Server contenant un Client (`import`)
- Client contenant un Serveur (`import`)

Pour nous aider, il existe des composants :

- `server.tsx` : Le composant `<Server>` contenant `‘use server’`
- `client.tsx` : Le composant `<Client>` contenant `‘use client’`
- `clientWithServer.tsx` : Composant client qui importe un `<Server>`
- `servertWithClient.tsx` : Composant serveur qui importe un `<Client>`

Fichiers qu’il nous suffira d’importer et utiliser dans `page.tsx`

<aside>
💡 *PS : `<ClientWithServer />` risque de poser problème ce qui est normal un `RCC` ne peut pas importer un `RSC`*

</aside>

Fichiers

- `exercise/composition/page.tsx`

## Bonus

### 1. 🚀 RCIC (React Contextual Isomorphic Component)

Les `RCIC` ne sont pas nommés explicitement comme cela dans la documentation de `Next.js`. J’ai défini ce terme explicitement pour décrire un type particulier de composants `React` dans `Next.js`.

- **React Component** : Ce sont des composants React classiques.
- **Isomorphic** : Ils peuvent s'exécuter côté `Client` ou côté `Server`, selon le contexte.
  - **Sans interactivité client** : Pas d'utilisation de `hooks` ou d'événements spécifiques au client.
  - **Sans opérations serveur** : Pas d'opérations d'entrée/sortie (IO) ou d'accès aux ressources serveur directes.
- **Contextual** : Leur type (client ou serveur) dépend du contexte dans lequel ils sont inclus (importés).
  - Lorsqu'ils sont inclus (importés) dans un composant client, ils adoptent le comportement du client.
  - Lorsqu'ils sont inclus (importés) dans un composant serveur, ils adoptent le comportement du serveur.
  - Lorsqu'ils sont passés en tant que `children` à un composant (client ou serveur), ils sont serveur par défaut.

Dans notre arbre de composant, à partir du moment où un composant devient explicitement client `‘use client’` les `RCIC` enfant importés seront des `clients`. Ce qui alourdit le bundle et peut rendre l’`hydration` plus longue. Voilà pourquoi il est recommandé :

<aside>
💡 Descendre les `RCC` le plus bas possible dans l’arbre de composant

</aside>

Exemple de composition identique . La seule différence est le parent :

![compo-iso-tree.png](/course/compo-iso-tree.png)

```tsx
![compo-iso-tree.png](/course/compo-iso-tree.png)
```

- 🐶 Dans cet exercice, nous avons un `RSC` (`server.tsx` `<Server>`) mais qui ne contient pas de code spécifique au client (`FS` par exemple) ou de code client (`Hook`, `Localstorage` par exemple)

**Il est donc candidat pour être un `RCIC`**

- 🐶 Transforme le en `RCIC` (`server.tsx`)
  - **⛏️ Supprime la directive** `use server`
  - **🤖 Change son type pour l’afficher correctement :**
    **🤖**`componentType={ComponentTypeEnum.ISOMORPHIC}`

```tsx
//server.tsx
'use server'
import React from 'react'
import {CardComponentType} from '@/components/card-component-type'
import {ComponentTypeEnum, detectActualType} from '@/lib/helper'

export default async function Server({children}: {children?: React.ReactNode}) {
  const actualType = detectActualType()
  return (
    <CardComponentType
      componentType={ComponentTypeEnum.SERVER}
      actualType={actualType}
    >
      {children}
    </CardComponentType>
  )
}
```

- 🐶 Utilise le dans `page.tsx`

```tsx
<ClientWithServer />
```

Fichiers

- `exercise/composition/server.tsx`
- `exercise/composition/page.tsx`

## Aller plus loin

📑 Le lien vers la doc [https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components](https://rc.nextjs.org/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=04%20Rendering%20Avancée&entry.533578441=07%20composition-patterns).
